# QA-003: E2E Test Suite

**Story ID:** QA-003
**Story Points:** 8
**Epic Link:** Quality Assurance & Testing
**Status:** Ready for Development

## Description

Implement comprehensive end-to-end (E2E) testing using Playwright to validate the Outlook add-in across multiple platforms (Windows Desktop, Mac Desktop, Outlook Web). Test complete user workflows from authentication through case filing, including cross-platform compatibility, Office.js API integration, and real API interactions. Focus on critical user journeys and platform-specific behavior.

This story ensures the add-in works correctly in real Outlook environments across different operating systems and Outlook clients.

## Acceptance Criteria

1. **Playwright Setup**
   - Playwright configured for Outlook add-in testing
   - Test environment setup for desktop and web
   - Browser contexts configured (Chromium, Webkit, Firefox)
   - Office.js testing utilities configured
   - Test data management and cleanup

2. **Platform Coverage**
   - **Windows Desktop**: Outlook Desktop (Office 365) on Windows 10/11
   - **Mac Desktop**: Outlook Desktop (Office 365) on macOS
   - **Outlook Web**: Outlook Web Access (OWA) in browsers (Chrome, Edge, Safari)
   - Test matrix covering all critical workflows per platform

3. **Critical User Journeys (90%+ pass rate)**
   - Complete authentication flow (MSAL login)
   - Case list loading and display
   - Case search and filtering
   - Case selection (via dropdown and suggestions)
   - Email filing to case (idempotent)
   - Category application (filed/unfiled)
   - Favorites management
   - Error handling and recovery
   - Offline mode behavior

4. **Cross-Platform Testing**
   - Same test suite runs on all platforms
   - Platform-specific variations handled gracefully
   - Office.js API compatibility verified
   - Performance benchmarks per platform
   - Screenshot comparison for UI consistency

5. **API Integration Testing**
   - Real API calls to SingleCase backend (test environment)
   - Authentication token management
   - API error handling (401, 403, 500, network errors)
   - Rate limiting and retry logic
   - API response validation

6. **Test Reporting**
   - HTML test report with screenshots/videos
   - Test execution time per platform
   - Flaky test detection and reporting
   - CI/CD integration with test artifacts
   - Trend analysis (pass/fail rates over time)

## Technical Requirements

### Playwright Configuration

1. **playwright.config.ts** (create at project root)
   ```typescript
   import { defineConfig, devices } from '@playwright/test';

   export default defineConfig({
     testDir: './e2e',
     fullyParallel: false, // Sequential for Outlook add-in tests
     forbidOnly: !!process.env.CI,
     retries: process.env.CI ? 2 : 0,
     workers: process.env.CI ? 1 : 1, // One worker for Outlook stability
     reporter: [
       ['html', { outputFolder: 'playwright-report' }],
       ['json', { outputFile: 'test-results/results.json' }],
       ['junit', { outputFile: 'test-results/junit.xml' }],
     ],
     use: {
       baseURL: 'https://localhost:3000',
       trace: 'on-first-retry',
       screenshot: 'only-on-failure',
       video: 'retain-on-failure',
       actionTimeout: 15000,
       navigationTimeout: 30000,
     },

     projects: [
       {
         name: 'outlook-web-chromium',
         use: {
           ...devices['Desktop Chrome'],
           viewport: { width: 1280, height: 720 },
         },
       },
       {
         name: 'outlook-web-webkit',
         use: {
           ...devices['Desktop Safari'],
           viewport: { width: 1280, height: 720 },
         },
       },
       {
         name: 'outlook-web-firefox',
         use: {
           ...devices['Desktop Firefox'],
           viewport: { width: 1280, height: 720 },
         },
       },
       // Desktop Outlook requires special setup (see notes)
       {
         name: 'outlook-desktop-windows',
         use: {
           ...devices['Desktop Edge'],
           // Special config for Windows Desktop testing
         },
         testMatch: /.*\.desktop\.spec\.ts/,
       },
     ],

     webServer: {
       command: 'npm run dev-server',
       url: 'https://localhost:3000',
       reuseExistingServer: !process.env.CI,
       timeout: 120000,
     },
   });
   ```

2. **Update package.json**
   ```json
   {
     "scripts": {
       "test:e2e": "playwright test",
       "test:e2e:headed": "playwright test --headed",
       "test:e2e:debug": "playwright test --debug",
       "test:e2e:ui": "playwright test --ui",
       "test:e2e:report": "playwright show-report"
     },
     "devDependencies": {
       "@playwright/test": "^1.42.0"
     }
   }
   ```

### Test Utilities

1. **e2e/utils/outlookHelpers.ts**
   ```typescript
   import { Page, expect } from '@playwright/test';

   export class OutlookTestHelper {
     constructor(private page: Page) {}

     /**
      * Navigate to Outlook Web and wait for page load
      */
     async navigateToOutlookWeb() {
       await this.page.goto('https://outlook.office.com/mail');
       await this.page.waitForLoadState('networkidle');
     }

     /**
      * Login to Microsoft 365 (for Outlook Web tests)
      */
     async loginToM365(email: string, password: string) {
       // Fill email
       await this.page.fill('input[type="email"]', email);
       await this.page.click('input[type="submit"]');

       // Fill password
       await this.page.waitForSelector('input[type="password"]');
       await this.page.fill('input[type="password"]', password);
       await this.page.click('input[type="submit"]');

       // Handle "Stay signed in?" prompt
       await this.page.waitForTimeout(2000);
       const staySignedInButton = this.page.locator('input[value="No"]');
       if (await staySignedInButton.isVisible()) {
         await staySignedInButton.click();
       }

       await this.page.waitForLoadState('networkidle');
     }

     /**
      * Open an email in Outlook Web
      */
     async openEmail(subject: string) {
       const emailRow = this.page.locator(`[aria-label*="${subject}"]`).first();
       await emailRow.click();
       await this.page.waitForTimeout(1000);
     }

     /**
      * Open the Outlook add-in task pane
      */
     async openAddinTaskPane() {
       // Click add-in button in ribbon (varies by platform)
       const addinButton = this.page.locator('[aria-label="SingleCase"]');
       await addinButton.click();

       // Wait for task pane iframe to load
       const taskPaneFrame = this.page.frameLocator('iframe[title="SingleCase"]');
       await taskPaneFrame.locator('body').waitFor();

       return taskPaneFrame;
     }

     /**
      * Get the add-in iframe (task pane)
      */
     getAddinFrame() {
       return this.page.frameLocator('iframe[title="SingleCase"]');
     }

     /**
      * Wait for add-in to be fully loaded
      */
     async waitForAddinReady() {
       const frame = this.getAddinFrame();
       await frame.locator('[data-testid="main-workspace"]').waitFor();
     }

     /**
      * Create a test email
      */
     async createTestEmail(options: {
       to: string;
       subject: string;
       body: string;
     }) {
       await this.page.click('[aria-label="New mail"]');
       await this.page.fill('input[aria-label="To"]', options.to);
       await this.page.fill('input[aria-label="Add a subject"]', options.subject);

       const bodyEditor = this.page.locator('[role="textbox"][aria-label*="Message body"]');
       await bodyEditor.fill(options.body);

       // Don't send, just save as draft
       await this.page.keyboard.press('Escape');
     }
   }
   ```

2. **e2e/fixtures/testData.ts**
   ```typescript
   export const TEST_USER = {
     email: process.env.TEST_USER_EMAIL || 'testuser@example.com',
     password: process.env.TEST_USER_PASSWORD || 'TestPassword123!',
   };

   export const TEST_WORKSPACE = {
     host: process.env.TEST_WORKSPACE_HOST || 'demo.singlecase.ch',
     publicToken: process.env.TEST_PUBLIC_TOKEN || 'test-token-123',
   };

   export const TEST_CASES = [
     {
       id: 'test-case-1',
       name: 'E2E Test Case 1',
       client: 'Test Client A',
     },
     {
       id: 'test-case-2',
       name: 'E2E Test Case 2',
       client: 'Test Client B',
     },
   ];

   export const TEST_EMAIL = {
     subject: 'E2E Test Email - ' + Date.now(),
     to: 'recipient@example.com',
     body: 'This is a test email for E2E testing.',
   };
   ```

### E2E Test Suites

1. **e2e/authentication.spec.ts**
   ```typescript
   import { test, expect } from '@playwright/test';
   import { OutlookTestHelper } from './utils/outlookHelpers';
   import { TEST_USER, TEST_WORKSPACE } from './fixtures/testData';

   test.describe('Authentication Flow', () => {
     let outlook: OutlookTestHelper;

     test.beforeEach(async ({ page }) => {
       outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();
       await outlook.loginToM365(TEST_USER.email, TEST_USER.password);
     });

     test('should authenticate with MSAL successfully', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();

       // Wait for authentication prompt or automatic login
       await frame.locator('[data-testid="user-profile"]').waitFor({
         timeout: 30000,
       });

       // Verify user is authenticated
       const userEmail = await frame
         .locator('[data-testid="user-email"]')
         .textContent();
       expect(userEmail).toContain(TEST_USER.email);
     });

     test('should handle authentication failure gracefully', async ({ page }) => {
       // Simulate auth failure by clearing cookies
       await page.context().clearCookies();

       const frame = await outlook.openAddinTaskPane();

       // Should show login button or error message
       const loginButton = frame.locator('button:has-text("Sign In")');
       await expect(loginButton).toBeVisible();
     });

     test('should refresh token when expired', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();

       // Wait for initial authentication
       await frame.locator('[data-testid="main-workspace"]').waitFor();

       // Simulate token expiration (requires backend support)
       // Make API call that triggers token refresh
       const refreshButton = frame.locator('[data-testid="refresh-cases"]');
       await refreshButton.click();

       // Should succeed without showing login prompt
       await expect(frame.locator('[data-testid="case-list"]')).toBeVisible();
     });
   });
   ```

2. **e2e/filing-workflow.spec.ts**
   ```typescript
   import { test, expect } from '@playwright/test';
   import { OutlookTestHelper } from './utils/outlookHelpers';
   import { TEST_USER, TEST_EMAIL } from './fixtures/testData';

   test.describe('Email Filing Workflow', () => {
     let outlook: OutlookTestHelper;

     test.beforeEach(async ({ page }) => {
       outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();
       await outlook.loginToM365(TEST_USER.email, TEST_USER.password);
       await outlook.createTestEmail(TEST_EMAIL);
       await outlook.openEmail(TEST_EMAIL.subject);
     });

     test('should file email to case successfully', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();
       await outlook.waitForAddinReady();

       // Wait for cases to load
       await frame.locator('[data-testid="case-list"]').waitFor();

       // Select a case
       const caseSelector = frame.locator('[data-testid="case-selector"]');
       await caseSelector.click();

       const firstCase = frame.locator('[data-testid="case-option"]').first();
       await firstCase.click();

       // Click File button
       const fileButton = frame.locator('button:has-text("File Email")');
       await fileButton.click();

       // Wait for success message
       const successMessage = frame.locator('[data-testid="success-toast"]');
       await expect(successMessage).toBeVisible({ timeout: 10000 });
       await expect(successMessage).toContainText('Email filed successfully');

       // Verify category applied
       const categoryBadge = frame.locator('[data-testid="category-badge"]');
       await expect(categoryBadge).toContainText('Filed');
     });

     test('should prevent duplicate filing (idempotent)', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();
       await outlook.waitForAddinReady();

       // File email first time
       await frame.locator('[data-testid="case-selector"]').click();
       await frame.locator('[data-testid="case-option"]').first().click();
       await frame.locator('button:has-text("File Email")').click();
       await frame.locator('[data-testid="success-toast"]').waitFor();

       // Try to file again
       await frame.locator('button:has-text("File Email")').click();

       // Should show "Already filed" message
       const infoMessage = frame.locator('[data-testid="info-toast"]');
       await expect(infoMessage).toBeVisible();
       await expect(infoMessage).toContainText('already filed');
     });

     test('should handle filing errors gracefully', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();

       // Intercept API call and return error
       await page.route('**/publicapi/v1/cases/*/links', (route) => {
         route.fulfill({
           status: 500,
           body: JSON.stringify({ error: 'Internal server error' }),
         });
       });

       await frame.locator('[data-testid="case-selector"]').click();
       await frame.locator('[data-testid="case-option"]').first().click();
       await frame.locator('button:has-text("File Email")').click();

       // Should show error message
       const errorMessage = frame.locator('[data-testid="error-toast"]');
       await expect(errorMessage).toBeVisible();
       await expect(errorMessage).toContainText('Failed to file email');
     });

     test('should show filing progress indicator', async ({ page }) => {
       const frame = await outlook.openAddinTaskPane();

       await frame.locator('[data-testid="case-selector"]').click();
       await frame.locator('[data-testid="case-option"]').first().click();

       const fileButton = frame.locator('button:has-text("File Email")');
       await fileButton.click();

       // Should show loading state immediately
       await expect(fileButton).toBeDisabled();
       const spinner = frame.locator('[data-testid="filing-spinner"]');
       await expect(spinner).toBeVisible();

       // Wait for completion
       await frame.locator('[data-testid="success-toast"]').waitFor();
       await expect(fileButton).toBeEnabled();
       await expect(spinner).not.toBeVisible();
     });
   });
   ```

3. **e2e/case-suggestions.spec.ts**
   ```typescript
   import { test, expect } from '@playwright/test';
   import { OutlookTestHelper } from './utils/outlookHelpers';
   import { TEST_USER } from './fixtures/testData';

   test.describe('Case Suggestions', () => {
     let outlook: OutlookTestHelper;

     test.beforeEach(async ({ page }) => {
       outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();
       await outlook.loginToM365(TEST_USER.email, TEST_USER.password);
     });

     test('should display suggested cases based on email context', async ({ page }) => {
       // Create email with specific context (e.g., sender from known client)
       await outlook.createTestEmail({
         to: 'john@acmecorp.com',
         subject: 'Project Alpha Discussion',
         body: 'Regarding the Alpha project...',
       });

       await outlook.openEmail('Project Alpha Discussion');
       const frame = await outlook.openAddinTaskPane();

       // Wait for suggestions to appear
       const suggestionsSection = frame.locator('[data-testid="suggestions"]');
       await expect(suggestionsSection).toBeVisible();

       const suggestions = frame.locator('[data-testid="suggestion-item"]');
       await expect(suggestions).toHaveCount(1, { timeout: 5000 });

       // Verify suggestion details
       const firstSuggestion = suggestions.first();
       await expect(firstSuggestion).toContainText('Project Alpha');
       await expect(firstSuggestion).toContainText('Email domain match');
     });

     test('should allow filing to suggested case with one click', async ({ page }) => {
       await outlook.createTestEmail({
         to: 'contact@testclient.com',
         subject: 'Test Case Email',
         body: 'Test body',
       });

       await outlook.openEmail('Test Case Email');
       const frame = await outlook.openAddinTaskPane();

       const firstSuggestion = frame.locator('[data-testid="suggestion-item"]').first();
       const fileButton = firstSuggestion.locator('button:has-text("File")');
       await fileButton.click();

       // Should file without selecting from dropdown
       const successMessage = frame.locator('[data-testid="success-toast"]');
       await expect(successMessage).toBeVisible();
     });
   });
   ```

4. **e2e/platform-compatibility.spec.ts**
   ```typescript
   import { test, expect } from '@playwright/test';
   import { OutlookTestHelper } from './utils/outlookHelpers';

   test.describe('Platform Compatibility', () => {
     test('should work in Chromium-based browsers', async ({ page, browserName }) => {
       test.skip(browserName !== 'chromium', 'Chromium-specific test');

       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();

       // Test add-in loads and functions
       const frame = await outlook.openAddinTaskPane();
       await expect(frame.locator('[data-testid="main-workspace"]')).toBeVisible();
     });

     test('should work in Safari/Webkit', async ({ page, browserName }) => {
       test.skip(browserName !== 'webkit', 'Safari-specific test');

       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();

       // Test add-in loads and functions
       const frame = await outlook.openAddinTaskPane();
       await expect(frame.locator('[data-testid="main-workspace"]')).toBeVisible();
     });

     test('should work in Firefox', async ({ page, browserName }) => {
       test.skip(browserName !== 'firefox', 'Firefox-specific test');

       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();

       // Test add-in loads and functions
       const frame = await outlook.openAddinTaskPane();
       await expect(frame.locator('[data-testid="main-workspace"]')).toBeVisible();
     });

     test('should handle Office.js API differences across platforms', async ({ page }) => {
       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();

       const frame = await outlook.openAddinTaskPane();

       // Test category API (may differ across platforms)
       await frame.locator('[data-testid="category-badge"]').click();
       await frame.locator('button:has-text("Apply Filed")').click();

       // Should succeed or gracefully fallback
       const toast = frame.locator('[data-testid^="toast"]').first();
       await expect(toast).toBeVisible();
       // Either success or fallback message
       const toastText = await toast.textContent();
       expect(toastText).toMatch(/(success|applied|fallback)/i);
     });
   });
   ```

5. **e2e/performance.spec.ts**
   ```typescript
   import { test, expect } from '@playwright/test';
   import { OutlookTestHelper } from './utils/outlookHelpers';

   test.describe('Performance Benchmarks', () => {
     test('add-in should load within 3 seconds', async ({ page }) => {
       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();

       const startTime = Date.now();
       await outlook.openAddinTaskPane();
       await outlook.waitForAddinReady();
       const loadTime = Date.now() - startTime;

       expect(loadTime).toBeLessThan(3000);
       console.log(`Add-in load time: ${loadTime}ms`);
     });

     test('case list should load within 2 seconds', async ({ page }) => {
       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();
       const frame = await outlook.openAddinTaskPane();

       const startTime = Date.now();
       await frame.locator('[data-testid="case-list"]').waitFor();
       const loadTime = Date.now() - startTime;

       expect(loadTime).toBeLessThan(2000);
       console.log(`Case list load time: ${loadTime}ms`);
     });

     test('filing operation should complete within 5 seconds', async ({ page }) => {
       const outlook = new OutlookTestHelper(page);
       await outlook.navigateToOutlookWeb();
       await outlook.createTestEmail({
         to: 'test@example.com',
         subject: 'Performance Test',
         body: 'Test',
       });
       await outlook.openEmail('Performance Test');

       const frame = await outlook.openAddinTaskPane();
       await frame.locator('[data-testid="case-selector"]').click();
       await frame.locator('[data-testid="case-option"]').first().click();

       const startTime = Date.now();
       await frame.locator('button:has-text("File Email")').click();
       await frame.locator('[data-testid="success-toast"]').waitFor();
       const filingTime = Date.now() - startTime;

       expect(filingTime).toBeLessThan(5000);
       console.log(`Filing time: ${filingTime}ms`);
     });
   });
   ```

### CI/CD Integration

1. **GitHub Actions Workflow (.github/workflows/e2e-tests.yml)**
   ```yaml
   name: E2E Tests

   on:
     pull_request:
       branches: [main, develop]
     push:
       branches: [main]

   jobs:
     e2e-tests:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: '18'

         - name: Install dependencies
           run: npm ci

         - name: Install Playwright
           run: npx playwright install --with-deps

         - name: Run E2E tests
           env:
             TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
             TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
             TEST_WORKSPACE_HOST: ${{ secrets.TEST_WORKSPACE_HOST }}
             TEST_PUBLIC_TOKEN: ${{ secrets.TEST_PUBLIC_TOKEN }}
           run: npm run test:e2e

         - name: Upload test results
           if: always()
           uses: actions/upload-artifact@v4
           with:
             name: playwright-report
             path: playwright-report/
             retention-days: 30

         - name: Upload test videos
           if: failure()
           uses: actions/upload-artifact@v4
           with:
             name: test-videos
             path: test-results/
             retention-days: 7
   ```

## Test Execution Strategy

### Local Testing
```bash
# Run all E2E tests
npm run test:e2e

# Run specific test file
npx playwright test e2e/filing-workflow.spec.ts

# Run with UI mode (debugging)
npm run test:e2e:ui

# Run headed (see browser)
npm run test:e2e:headed

# Run specific project (browser)
npx playwright test --project=outlook-web-chromium
```

### CI Testing
- Run on every PR to main/develop
- Run nightly for all platforms
- Parallel execution per browser (if stable)
- Retry flaky tests (max 2 retries)
- Archive artifacts for 30 days

### Platform-Specific Testing
- **Windows Desktop**: Requires Windows runner, special setup
- **Mac Desktop**: Requires macOS runner
- **Web**: Run on Linux runners (cost-effective)

## Performance Benchmarks

| Metric | Target | Max Acceptable |
|--------|--------|----------------|
| Add-in load time | < 2s | < 3s |
| Case list load | < 1s | < 2s |
| Filing operation | < 3s | < 5s |
| Search response | < 500ms | < 1s |
| Category application | < 1s | < 2s |

## Dependencies

- **Depends on**: QA-001 (Backend Tests) - validates business logic
- **Depends on**: QA-002 (Frontend Tests) - validates components
- **Required for**: QA-004 (UAT Test Plan) - validates real workflows
- **Required for**: QA-006 (UAT Sign-off) - production readiness
- **Blocks**: Production deployment if critical paths fail

## Notes

1. **Outlook Desktop Testing Challenges**
   - Requires Outlook installed on test machine
   - No easy way to automate Outlook Desktop (Windows/Mac)
   - Recommended: Manual testing on Desktop, automated on Web
   - Alternative: Use Outlook Web as proxy for Desktop behavior

2. **Office.js Testing**
   - Office.js APIs only work in Outlook context
   - Mock Office.js in unit tests, use real APIs in E2E
   - Some APIs behave differently on Desktop vs Web
   - Test graceful degradation when APIs unavailable

3. **Flaky Test Prevention**
   - Use explicit waits (waitFor) instead of timeouts
   - Wait for network idle before interactions
   - Retry transient failures (network issues)
   - Isolate tests (don't depend on previous test state)
   - Clean up test data after each test

4. **Test Data Management**
   - Use dedicated test workspace/environment
   - Create test cases programmatically (API)
   - Clean up test emails after tests
   - Use unique identifiers (timestamps) to avoid conflicts

5. **Security Considerations**
   - Store credentials in GitHub Secrets (CI)
   - Use environment variables for local testing
   - Never commit credentials to repository
   - Use separate test account (not production)

6. **Performance Optimization**
   - Run tests sequentially (Outlook stability)
   - Reuse authentication sessions (cookies)
   - Parallel execution per browser (if stable)
   - Cache Playwright browsers in CI

## Definition of Done

- [ ] Playwright configured for Outlook add-in testing
- [ ] Test utilities and helpers created (OutlookTestHelper)
- [ ] Authentication flow E2E test implemented
- [ ] Filing workflow E2E test implemented
- [ ] Case suggestions E2E test implemented
- [ ] Platform compatibility tests implemented
- [ ] Performance benchmark tests implemented
- [ ] Error handling E2E tests implemented
- [ ] Idempotent filing tested end-to-end
- [ ] Category application tested across platforms
- [ ] Tests run successfully on Outlook Web (Chrome, Safari, Firefox)
- [ ] Test report generated (HTML, JSON, JUnit)
- [ ] CI/CD pipeline configured (GitHub Actions)
- [ ] Test videos captured on failure
- [ ] Test documentation added (README)
- [ ] 90%+ pass rate on critical user journeys
- [ ] Performance benchmarks meet targets
- [ ] Flaky tests identified and fixed

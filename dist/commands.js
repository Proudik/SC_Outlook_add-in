/*! For license information please see commands.js.LICENSE.txt */
!function(){var e={64583:function(e,t,n){e.exports=function(){"use strict";function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},o=0,r=void 0,i=void 0,s=function(e,t){m[o]=e,m[o+1]=t,2===(o+=2)&&(i?i(g):b())};var c="undefined"!=typeof window?window:void 0,a=c||{},l=a.MutationObserver||a.WebKitMutationObserver,u="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),f="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(g,1)}}var m=new Array(1e3);function g(){for(var e=0;e<o;e+=2)(0,m[e])(m[e+1]),m[e]=void 0,m[e+1]=void 0;o=0}var h,v,p,y,b=void 0;function S(e,t){var n=this,o=new this.constructor(I);void 0===o[O]&&F(o);var r=n._state;if(r){var i=arguments[r-1];s(function(){return N(r,o,i,n._result)})}else E(n,o,e,t);return o}function w(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(I);return R(t,e),t}b=u?function(){return process.nextTick(g)}:l?(v=0,p=new l(g),y=document.createTextNode(""),p.observe(y,{characterData:!0}),function(){y.data=v=++v%2}):f?((h=new MessageChannel).port1.onmessage=g,function(){return h.port2.postMessage(0)}):void 0===c?function(){try{var e=Function("return this")().require("vertx");return void 0!==(r=e.runOnLoop||e.runOnContext)?function(){r(g)}:d()}catch(e){return d()}}():d();var O=Math.random().toString(36).substring(2);function I(){}var x=void 0,k=1,_=2;function j(t,n,o){n.constructor===t.constructor&&o===S&&n.constructor.resolve===w?function(e,t){t._state===k?C(e,t._result):t._state===_?T(e,t._result):E(t,void 0,function(t){return R(e,t)},function(t){return T(e,t)})}(t,n):void 0===o?C(t,n):e(o)?function(e,t,n){s(function(e){var o=!1,r=function(e,t,n,o){try{e.call(t,n,o)}catch(e){return e}}(n,t,function(n){o||(o=!0,t!==n?R(e,n):C(e,n))},function(t){o||(o=!0,T(e,t))},e._label);!o&&r&&(o=!0,T(e,r))},e)}(t,n,o):C(t,n)}function R(e,t){if(e===t)T(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(o=t),null===o||"object"!==r&&"function"!==r)C(e,t);else{var n=void 0;try{n=t.then}catch(t){return void T(e,t)}j(e,t,n)}var o,r}function A(e){e._onerror&&e._onerror(e._result),M(e)}function C(e,t){e._state===x&&(e._result=t,e._state=k,0!==e._subscribers.length&&s(M,e))}function T(e,t){e._state===x&&(e._state=_,e._result=t,s(A,e))}function E(e,t,n,o){var r=e._subscribers,i=r.length;e._onerror=null,r[i]=t,r[i+k]=n,r[i+_]=o,0===i&&e._state&&s(M,e)}function M(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var o=void 0,r=void 0,i=e._result,s=0;s<t.length;s+=3)o=t[s],r=t[s+n],o?N(n,o,r,i):r(i);e._subscribers.length=0}}function N(t,n,o,r){var i=e(o),s=void 0,c=void 0,a=!0;if(i){try{s=o(r)}catch(e){a=!1,c=e}if(n===s)return void T(n,new TypeError("A promises callback cannot return that same promise."))}else s=r;n._state!==x||(i&&a?R(n,s):!1===a?T(n,c):t===k?C(n,s):t===_&&T(n,s))}var H=0;function F(e){e[O]=H++,e._state=void 0,e._result=void 0,e._subscribers=[]}var D=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(I),this.promise[O]||F(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?C(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&C(this.promise,this._result))):T(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===x&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,o=n.resolve;if(o===w){var r=void 0,i=void 0,s=!1;try{r=e.then}catch(e){s=!0,i=e}if(r===S&&e._state!==x)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===U){var c=new n(I);s?T(c,i):j(c,e,r),this._willSettleAt(c,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(o(e),t)},e.prototype._settledAt=function(e,t,n){var o=this.promise;o._state===x&&(this._remaining--,e===_?T(o,n):this._result[t]=n),0===this._remaining&&C(o,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;E(e,void 0,function(e){return n._settledAt(k,t,e)},function(e){return n._settledAt(_,t,e)})},e}();var U=function(){function t(e){this[O]=H++,this._result=this._state=void 0,this._subscribers=[],I!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t(function(t){R(e,t)},function(t){T(e,t)})}catch(t){T(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,o=n.constructor;return e(t)?n.then(function(e){return o.resolve(t()).then(function(){return e})},function(e){return o.resolve(t()).then(function(){throw e})}):n.then(t,t)},t}();return U.prototype.then=S,U.all=function(e){return new D(this,e).promise},U.race=function(e){var n=this;return t(e)?new n(function(t,o){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,o)}):new n(function(e,t){return t(new TypeError("You must pass an array to race."))})},U.resolve=w,U.reject=function(e){var t=new this(I);return T(t,e),t},U._setScheduler=function(e){i=e},U._setAsap=function(e){s=e},U._asap=s,U.polyfill=function(){var e=void 0;if(void 0!==n.g)e=n.g;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var o=null;try{o=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===o&&!t.cast)return}e.Promise=U},U.Promise=U,U}()}},t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(){"use strict";var e=n(64583).Promise,t=function(t,n,o,r){return new(o||(o=e))(function(e,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(s,c)}a((r=r.apply(t,n||[])).next())})},o=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},r="singlecase_token",i="singlecase_user_email",s="singlecase_auth_issued_at",c="sc_token",a="sc_user_email",l="sc_auth_issued_at";function u(e){var t=(e||"").trim().toLowerCase();return t.length>0?t:"unknown@singlecase.local"}function f(e){return t(this,void 0,void 0,function(){var t,n,r;return o(this,function(o){switch(o.label){case 0:if("undefined"==typeof OfficeRuntime||!(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage))return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,OfficeRuntime.storage.getItem(e)];case 2:return"string"==typeof(n=o.sent())?[2,n]:[3,4];case 3:return t=o.sent(),console.warn("[rtGet] OfficeRuntime.storage.getItem failed:",t),[3,4];case 4:if(null===(r=null===Office||void 0===Office?void 0:Office.context)||void 0===r?void 0:r.roamingSettings)try{if("string"==typeof(n=Office.context.roamingSettings.get(e)))return[2,n]}catch(e){console.warn("[rtGet] roamingSettings.get failed:",e)}return[2,null]}})})}function d(e){return t(this,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,OfficeRuntime.storage.removeItem(e)];case 1:case 2:return t.sent(),[3,3];case 3:return[2]}})})}function m(){return t(this,void 0,void 0,function(){var t,n,r,i;return o(this,function(o){switch(o.label){case 0:return[4,e.all([f(c),f(a),f(l)])];case 1:return t=o.sent(),n=t[0],r=t[1],i=t[2],[2,{token:n,email:u(r),issuedAt:i?Number(i):0}]}})})}function g(){return t(this,void 0,void 0,function(){var e,t,n,r;return o(this,function(o){switch(o.label){case 0:return[4,m()];case 1:return e=o.sent(),t=e.token,n=e.issuedAt,t?(r=Date.now()-(n||0),!n||r>288e5?[4,h()]:[3,3]):[2];case 2:o.sent(),o.label=3;case 3:return[2]}})})}function h(){return t(this,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:return sessionStorage.removeItem(r),sessionStorage.removeItem(i),sessionStorage.removeItem(s),[4,e.all([d(c),d(a),d(l)])];case 1:return t.sent(),[2]}})})}var v=n(64583).Promise,p=function(e,t,n,o){return new(n||(n=v))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}a((o=o.apply(e,t||[])).next())})},y=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},b=!1;function S(){try{return"undefined"!=typeof OfficeRuntime&&!!(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage)}catch(e){return!1}}function w(){var e;try{return!!(null===(e=null===Office||void 0===Office?void 0:Office.context)||void 0===e?void 0:e.roamingSettings)}catch(e){return!1}}function O(){return p(this,void 0,void 0,function(){var e;return y(this,function(t){switch(t.label){case 0:return e=Date.now(),[4,new v(function(t,n){try{Office.context.roamingSettings.saveAsync(function(o){var r,i,s,c=Date.now()-e;if((null==o?void 0:o.status)===Office.AsyncResultStatus.Succeeded)t();else{var a=(null===(r=null==o?void 0:o.error)||void 0===r?void 0:r.message)||"roamingSettings.saveAsync failed";console.error("[saveRoamingSettings] ❌ Failed in ".concat(c,"ms:"),a,{status:null==o?void 0:o.status,errorCode:null===(i=null==o?void 0:o.error)||void 0===i?void 0:i.code,errorName:null===(s=null==o?void 0:o.error)||void 0===s?void 0:s.name}),n(new Error(a))}})}catch(t){var o=Date.now()-e;console.error("[saveRoamingSettings] ❌ Exception in ".concat(o,"ms:"),t),n(t)}})];case 1:return t.sent(),[4,new v(function(e){return setTimeout(e,100)})];case 2:return t.sent(),[2]}})})}function I(e){return p(this,arguments,void 0,function(e,t){var n,o,r,i,s,c,a;return void 0===t&&(t=!1),y(this,function(l){switch(l.label){case 0:if(!(n=String(e||"").trim()))return[2,null];o=S()?"OfficeRuntime.storage":w()?"roamingSettings":"localStorage",(r=b)&&console.log("[getStored] Using storage backend:",o,"for key:",n,t?"(force fresh)":""),l.label=1;case 1:return l.trys.push([1,7,,8]),S()?[4,OfficeRuntime.storage.getItem(n)]:[3,3];case 2:return i=l.sent(),r&&console.log("[getStored] Got from OfficeRuntime.storage:",n,i?"found (".concat(i.length," chars)"):"not found"),[2,"string"==typeof i?i:null];case 3:return w()?[3,5]:[3,6];case 4:l.sent(),l.label=5;case 5:return s=Office.context.roamingSettings.get(n),r&&console.log("[getStored] Got from roamingSettings:",n,s?"found (".concat(String(s).length," chars)"):"not found"),[2,"string"==typeof s?s:null];case 6:return c=localStorage.getItem(n),r&&console.warn("[getStored] No Office storage, using localStorage:",n,c?"found (".concat(c.length," chars)"):"not found"),[2,c];case 7:return a=l.sent(),console.warn("[getStored] Failed, falling back to localStorage:",a),[2,localStorage.getItem(n)];case 8:return[2]}})})}function x(e,t){return p(this,arguments,void 0,function(e,t,n){var o,r,i,s,c,a;return void 0===n&&(n=0),y(this,function(l){switch(l.label){case 0:if(!(o=String(e||"").trim()))return[2];r=String(null!=t?t:""),i=2,S()||w(),l.label=1;case 1:return l.trys.push([1,10,,11]),S()?[4,OfficeRuntime.storage.setItem(o,r)]:[3,3];case 2:return l.sent(),[2];case 3:if(!w())return[3,9];Office.context.roamingSettings.set(o,r),l.label=4;case 4:return l.trys.push([4,6,,9]),[4,O()];case 5:return l.sent(),[2];case 6:return s=l.sent(),console.error("[setStored] saveAsync failed:",s),n<i?(c=200*(n+1),[4,new v(function(e){return setTimeout(e,c)})]):[3,8];case 7:return l.sent(),[2,x(e,t,n+1)];case 8:throw s;case 9:return localStorage.setItem(o,r),[3,11];case 10:return a=l.sent(),console.warn("[setStored] ❌ Failed after retries, falling back to localStorage:",a),localStorage.setItem(o,r),[3,11];case 11:return[2]}})})}var k="sc:workspaceHost",_=n(64583).Promise,j=function(){return j=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},j.apply(this,arguments)},R=function(e,t,n,o){return new(n||(n=_))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}a((o=o.apply(e,t||[])).next())})},A=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}};function C(){return R(this,void 0,void 0,function(){var e,t,n;return A(this,function(o){switch(o.label){case 0:return console.log("[resolveApiBaseUrl] Reading workspaceHost from storage key:",k),[4,I(k)];case 1:if(e=o.sent(),console.log("[resolveApiBaseUrl] Raw stored host:",e),t=function(e){var t=(e||"").trim().toLowerCase();return t?t.replace(/^https?:\/\//i,"").split("/")[0]:""}(e||""),console.log("[resolveApiBaseUrl] Normalized host:",t),!t)throw console.error("[resolveApiBaseUrl] Workspace host is missing"),new Error("Workspace host is missing.");return n="/singlecase/".concat(encodeURIComponent(t),"/publicapi/v1"),console.log("[resolveApiBaseUrl] Resolved base URL:",n),[2,n]}})})}function T(){return R(this,void 0,void 0,function(){var e,t;return A(this,function(n){switch(n.label){case 0:return(null==(o=sessionStorage.getItem(r),c=sessionStorage.getItem(i),a=sessionStorage.getItem(s),e={token:o,email:u(c),issuedAt:a?Number(a):0})?void 0:e.token)?(console.log("[getToken] Using sessionStorage token"),[2,e.token]):(console.log("[getToken] sessionStorage token not available, trying OfficeRuntime.storage"),[4,m()]);case 1:if(null==(t=n.sent())?void 0:t.token)return console.log("[getToken] Using OfficeRuntime.storage token"),[2,t.token];throw console.error("[getToken] No token found in either sessionStorage or OfficeRuntime.storage"),new Error("Missing auth token.")}var o,c,a})})}function E(e,t){return R(this,void 0,void 0,function(){var n,o;return A(this,function(r){switch(r.label){case 0:return[4,e.text().catch(function(){return""})];case 1:if(n=r.sent(),!e.ok){if(423===e.status)throw new Error("Dokument je momentálně uzamčen. Někdo jej právě upravuje. Počkejte prosím, než se dokument odemkne, a zkuste to znovu.");throw new Error("".concat(t," (").concat(e.status,"): ").concat(n||e.statusText))}if(!(o=e.headers.get("content-type")||"").includes("application/json"))throw new Error("".concat(t,": expected JSON but got ").concat(o||"no content-type","."));return[2,JSON.parse(n)]}})})}function M(e){return R(this,void 0,void 0,function(){var t,n,o,r,i,s,c,a,l,u,f,d,m,g,h,v;return A(this,function(p){switch(p.label){case 0:return t=e.documentId,n=e.fileName,o=e.mimeType,r=e.dataBase64,i=e.directoryId,[4,T()];case 1:return s=p.sent(),[4,C()];case 2:c=p.sent(),a=encodeURIComponent(String(t)),l={name:n,mime_type:o,data_base64:r},i&&(l.dir_id=i),u=JSON.stringify(l),f=[{url:"".concat(c,"/documents/").concat(a,"/version"),method:"POST"},{url:"".concat(c,"/documents/").concat(a,"/versions"),method:"POST"},{url:"".concat(c,"/documents/").concat(a,"/versions"),method:"PUT"},{url:"".concat(c,"/documents/").concat(a,"/version"),method:"PUT"},{url:"".concat(c,"/documents/").concat(a,"/versions"),method:"PATCH"},{url:"".concat(c,"/documents/").concat(a,"/version"),method:"PATCH"}],d=null,m=0,g=f,p.label=3;case 3:return m<g.length?(h=g[m],[4,fetch(h.url,{method:h.method,headers:{"Content-Type":"application/json",Authentication:s,"Accept-Encoding":"identity"},body:u})]):[3,7];case 4:return 404===(v=p.sent()).status||405===v.status?(d=new Error("Endpoint not available: ".concat(h.method," ").concat(h.url," (").concat(v.status,")")),[3,6]):[4,E(v,"Upload version failed")];case 5:return[2,p.sent()];case 6:return m++,[3,3];case 7:throw d instanceof Error?d:new Error("Upload version failed: no supported endpoint found")}})})}function N(e){return R(this,void 0,void 0,function(){var t,n,o,r,i,s,c,a,l,u,f,d,m,g,h,v,p,y;return A(this,function(b){switch(b.label){case 0:t=e.caseId,n=e.fileName,o=e.mimeType,r=e.dataBase64,i=e.directoryId,s=e.metadata,console.log("[uploadDocumentToCase] Starting upload",{caseId:t,fileName:n,mimeType:o,dataLength:r.length}),b.label=1;case 1:return b.trys.push([1,3,,4]),[4,T()];case 2:return c=b.sent(),console.log("[uploadDocumentToCase] Token retrieved",{hasToken:!!c,tokenPrefix:c.slice(0,10)}),[3,4];case 3:throw a=b.sent(),console.error("[uploadDocumentToCase] Failed to get token:",a),a;case 4:return b.trys.push([4,6,,7]),[4,C()];case 5:return l=b.sent(),console.log("[uploadDocumentToCase] Base URL resolved:",l),[3,7];case 6:throw u=b.sent(),console.error("[uploadDocumentToCase] Failed to resolve base URL:",u),u;case 7:f="".concat(l,"/documents"),console.log("[uploadDocumentToCase] Full URL:",f),d={case_id:t,documents:[j(j({name:n,mime_type:o,data_base64:r},i?{dir_id:i}:{}),s?{metadata:s}:{})]},console.log("[uploadDocumentToCase] Payload structure:",{case_id:d.case_id,documentCount:d.documents.length,firstDoc:{name:d.documents[0].name,mime_type:d.documents[0].mime_type,data_base64_length:d.documents[0].data_base64.length}}),b.label=8;case 8:return b.trys.push([8,10,,11]),[4,fetch(f,{method:"POST",headers:{"Content-Type":"application/json",Authentication:c,"Accept-Encoding":"identity"},body:JSON.stringify(d)})];case 9:return m=b.sent(),console.log("[uploadDocumentToCase] Fetch completed",{status:m.status,statusText:m.statusText,ok:m.ok}),[3,11];case 10:throw g=b.sent(),console.error("[uploadDocumentToCase] Fetch failed:",g),new Error("Network request failed: ".concat(g instanceof Error?g.message:String(g)));case 11:return m.ok?[3,13]:[4,m.text().catch(function(){return""})];case 12:h=b.sent(),v=h.slice(0,300),console.error("[uploadDocumentToCase] Upload failed",{status:m.status,statusText:m.statusText,url:f,responseSnippet:v}),b.label=13;case 13:return[4,E(m,"Upload failed")];case 14:return p=b.sent(),console.log("[uploadDocumentToCase] Upload successful",{documentIds:null===(y=p.documents)||void 0===y?void 0:y.map(function(e){return e.id})}),[2,p]}})})}function H(e,t){if(void 0===t&&(t=!0),!e)return"";var n=e.trim().toLowerCase();if(n=n.replace(/\s+/g," "),t){var o=void 0;do{o=n.length,n=n.replace(/^(re|fw|fwd):\s*/i,"")}while(n.length!==o&&n.length>0)}return n.trim()}function F(e,t){return R(this,void 0,void 0,function(){var n,o,r,i,s,c,a,l,u,f,d,m,g,h,v,p,y,b;return A(this,function(S){switch(S.label){case 0:return console.log("[findDocumentBySubject] Searching for subject in case",{caseId:e,subject:t}),[4,T()];case 1:return n=S.sent(),[4,C()];case 2:o=S.sent(),r=["".concat(o,"/cases/").concat(encodeURIComponent(e),"/documents"),"".concat(o,"/documents?case_id=").concat(encodeURIComponent(e)),"".concat(o,"/cases/").concat(encodeURIComponent(e),"/files")],i=[],s=0,c=r,S.label=3;case 3:if(!(s<c.length))return[3,9];a=c[s],S.label=4;case 4:return S.trys.push([4,7,,8]),[4,fetch(a,{method:"GET",headers:{Authentication:n,"Content-Type":"application/json","Accept-Encoding":"identity"}})];case 5:return 404===(l=S.sent()).status||405===l.status?[3,8]:l.ok?[4,l.json()]:[3,8];case 6:return u=S.sent(),(i=Array.isArray(u)?u:Array.isArray(u.documents)?u.documents:Array.isArray(u.files)?u.files:Array.isArray(u.items)?u.items:[]).length>=0?(console.log("[findDocumentBySubject] Found",i.length,"documents in case"),[3,9]):[3,8];case 7:return S.sent(),[3,8];case 8:return s++,[3,3];case 9:if(0===i.length)return console.log("[findDocumentBySubject] No documents found in case"),[2,null];if(f=H(t),console.log("[findDocumentBySubject] Normalized search subject:",f),!f)return console.warn("[findDocumentBySubject] Empty normalized subject, skipping"),[2,null];for(d=0,m=i;d<m.length;d++)if(g=m[d],(h=String(g.name||g.filename||"")).toLowerCase().endsWith(".eml")&&((v=(null===(y=g.metadata)||void 0===y?void 0:y.subject)||g.subject||(null===(b=g.properties)||void 0===b?void 0:b.subject)||"")||(v=h.replace(/\.eml$/i,"")),p=H(v),console.log("[findDocumentBySubject] Comparing",{fileName:h,docSubject:v,normalizedDocSubject:p,matches:p===f}),p===f))return console.log("[findDocumentBySubject] Match found!",{id:g.id,name:h}),[2,{id:String(g.id||g._id),name:h,subject:v}];return console.log("[findDocumentBySubject] No matching document found"),[2,null]}})})}var D=n(64583).Promise,U=function(e,t,n,o){return new(n||(n=D))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}a((o=o.apply(e,t||[])).next())})},P=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},B="sc:filedEmailsCache";function K(e,t,n,o,r,i){return U(this,void 0,void 0,function(){var s,c,a,l,u,f,d,m,g,h,v,p,y,b,S,w,O;return P(this,function(k){switch(k.label){case 0:if(!e)return console.warn("[cacheFiledEmail] No conversationId provided, skipping cache"),[2];k.label=1;case 1:return k.trys.push([1,8,,9]),s={host:null===(y=null===(p=null===(v=null===Office||void 0===Office?void 0:Office.context)||void 0===v?void 0:v.mailbox)||void 0===p?void 0:p.diagnostics)||void 0===y?void 0:y.hostName,hostVersion:null===(w=null===(S=null===(b=null===Office||void 0===Office?void 0:Office.context)||void 0===b?void 0:b.mailbox)||void 0===S?void 0:S.diagnostics)||void 0===w?void 0:w.hostVersion,platform:null===(O=null===Office||void 0===Office?void 0:Office.context)||void 0===O?void 0:O.platform},console.log("[cacheFiledEmail] Platform info:",s),[4,I(B)];case 2:return c=k.sent(),a=c?JSON.parse(String(c)):{},console.log("[cacheFiledEmail] Current cache size:",Object.keys(a).length),a[e]={caseId:t,documentId:n,subject:o,caseName:r,caseKey:i,filedAt:Date.now()},(l=Object.entries(a)).length>100?(l.sort(function(e,t){return t[1].filedAt-e[1].filedAt}),u=l.slice(0,100),f={},u.forEach(function(e){var t=e[0],n=e[1];f[t]=n}),[4,x(B,JSON.stringify(f))]):[3,4];case 3:return k.sent(),console.log("[cacheFiledEmail] Cleaned cache, kept 100 most recent entries"),[3,6];case 4:return[4,x(B,JSON.stringify(a))];case 5:k.sent(),k.label=6;case 6:return[4,I(B)];case 7:return d=k.sent(),m=d?JSON.parse(String(d)):{},g=!!m[e],console.log("[cacheFiledEmail] Write verification:",{success:g,cacheSize:Object.keys(m).length}),console.log("[cacheFiledEmail] Cached filed email",{conversationId:e.substring(0,20)+"...",caseId:t,documentId:n,subject:o,writeVerified:g}),[3,9];case 8:return h=k.sent(),console.warn("[cacheFiledEmail] Failed to cache:",h),[3,9];case 9:return[2]}})})}function L(e,t,n,o,r){return U(this,void 0,void 0,function(){var i,s,c,a,l,u,f,d,m,g,h,v,p,y,b,S,w,O;return P(this,function(k){switch(k.label){case 0:if(!e)return console.warn("[cacheFiledEmailBySubject] No subject provided, skipping cache"),[2];k.label=1;case 1:return k.trys.push([1,8,,9]),i={host:null===(y=null===(p=null===(v=null===Office||void 0===Office?void 0:Office.context)||void 0===v?void 0:v.mailbox)||void 0===p?void 0:p.diagnostics)||void 0===y?void 0:y.hostName,hostVersion:null===(w=null===(S=null===(b=null===Office||void 0===Office?void 0:Office.context)||void 0===b?void 0:b.mailbox)||void 0===S?void 0:S.diagnostics)||void 0===w?void 0:w.hostVersion,platform:null===(O=null===Office||void 0===Office?void 0:Office.context)||void 0===O?void 0:O.platform},console.log("[cacheFiledEmailBySubject] Platform info:",i),[4,I(B)];case 2:return s=k.sent(),c=s?JSON.parse(String(s)):{},console.log("[cacheFiledEmailBySubject] Current cache size:",Object.keys(c).length),a="subj:".concat(e.trim().toLowerCase()),console.log("[cacheFiledEmailBySubject] Using temp key:",a),c[a]={caseId:t,documentId:n,subject:e,caseName:o,caseKey:r,filedAt:Date.now()},(l=Object.entries(c)).length>100?(l.sort(function(e,t){return t[1].filedAt-e[1].filedAt}),u=l.slice(0,100),f={},u.forEach(function(e){var t=e[0],n=e[1];f[t]=n}),[4,x(B,JSON.stringify(f))]):[3,4];case 3:return k.sent(),console.log("[cacheFiledEmailBySubject] Cleaned cache, kept 100 most recent entries"),[3,6];case 4:return[4,x(B,JSON.stringify(c))];case 5:k.sent(),k.label=6;case 6:return[4,I(B)];case 7:return d=k.sent(),m=d?JSON.parse(String(d)):{},g=!!m[a],console.log("[cacheFiledEmailBySubject] Write verification:",{success:g,cacheSize:Object.keys(m).length,tempKey:a}),console.log("[cacheFiledEmailBySubject] Cached filed email by subject",{subject:e,caseId:t,documentId:n,writeVerified:g}),[3,9];case 8:return h=k.sent(),console.warn("[cacheFiledEmailBySubject] Failed to cache:",h),[3,9];case 9:return[2]}})})}var z=n(64583).Promise,G=function(e,t,n,o){return new(n||(n=z))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}a((o=o.apply(e,t||[])).next())})},J=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},V=1e4;function W(e,t){return new z(function(n,o){var r=setTimeout(function(){return o(new Error("timeout"))},t);e.then(function(e){clearTimeout(r),n(e)},function(e){clearTimeout(r),o(e)})})}function Y(){try{var e=Office.context.mailbox.item;return String((null==e?void 0:e.conversationId)||(null==e?void 0:e.conversationKey)||"").trim()}catch(e){return""}}function q(e,t){return G(this,void 0,void 0,function(){var n,o,r,i;return J(this,function(s){switch(s.label){case 0:if(n=String(e||"").trim(),o=String(t||"").trim(),!n||!o)return[2];r=JSON.stringify({caseId:n,emailDocId:o}),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,x("sc_last_filed_ctx",r)];case 2:case 3:return s.sent(),[3,4];case 4:return s.trys.push([4,7,,8]),(i=Y())?[4,x("".concat("sc_conv_ctx:").concat(i),r)]:[3,6];case 5:s.sent(),s.label=6;case 6:return[3,8];case 7:return s.sent(),[3,8];case 8:return[2]}})})}function $(){return G(this,void 0,void 0,function(){var e,t,n,o,r,i,s;return J(this,function(c){switch(c.label){case 0:if(!(e=Office.context.mailbox.item))return console.warn("[getCandidateItemKeysRuntime] No item available"),[2,[]];if(console.log("[getCandidateItemKeysRuntime] Item properties:",{hasItemId:!!e.itemId,itemId:String(e.itemId||"").substring(0,20),hasConversationId:!!e.conversationId,conversationId:String(e.conversationId||"").substring(0,20),hasConversationKey:!!e.conversationKey,hasDateTimeCreated:!!e.dateTimeCreated,hasGetItemIdAsync:"function"==typeof e.getItemIdAsync,itemType:e.itemType}),t=[],(n=String(e.itemId||"").trim())&&t.push(n),"function"!=typeof e.getItemIdAsync)return[3,4];c.label=1;case 1:return c.trys.push([1,3,,4]),[4,new z(function(t){e.getItemIdAsync(function(e){(null==e?void 0:e.status)===Office.AsyncResultStatus.Succeeded?t(String(e.value||"")):t("")})})];case 2:return(o=c.sent())&&(console.log("[getCandidateItemKeysRuntime] getItemIdAsync returned:",o.substring(0,20)),t.push(o)),[3,4];case 3:return r=c.sent(),console.warn("[getCandidateItemKeysRuntime] getItemIdAsync failed:",r),[3,4];case 4:return(i=String(e.conversationId||e.conversationKey||"").trim())&&t.push("draft:".concat(i)),(s=String(e.dateTimeCreated||"").trim())&&t.push("draft:".concat(s)),t.push("draft:current"),t.push("last_compose"),console.log("[getCandidateItemKeysRuntime] Generated keys:",t),[2,Array.from(new Set(t.filter(Boolean)))]}})})}function Q(e){return G(this,void 0,void 0,function(){var t,n,o,r,i,s,c,a,l,u,f,d,m;return J(this,function(g){switch(g.label){case 0:t=0,n=e,g.label=1;case 1:if(!(t<n.length))return[3,9];o=n[t],r="sc_intent:".concat(o),console.log("[readIntentAny] Trying key:",r),g.label=2;case 2:if(g.trys.push([2,7,,8]),i=null,"undefined"==typeof OfficeRuntime||!(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage))return[3,6];g.label=3;case 3:return g.trys.push([3,5,,6]),[4,OfficeRuntime.storage.getItem(r)];case 4:return(i=g.sent())&&console.log("[readIntentAny] Found in OfficeRuntime.storage"),[3,6];case 5:return s=g.sent(),console.warn("[readIntentAny] OfficeRuntime.storage.getItem failed:",s),[3,6];case 6:if(!i&&(null===(m=null===Office||void 0===Office?void 0:Office.context)||void 0===m?void 0:m.roamingSettings))try{(i=Office.context.roamingSettings.get(r))&&console.log("[readIntentAny] Found in roamingSettings")}catch(e){console.warn("[readIntentAny] roamingSettings.get failed:",e)}return i?(c=JSON.parse(String(i)),a=String((null==c?void 0:c.caseId)||"").trim(),l=Boolean(null==c?void 0:c.autoFileOnSend),u=String((null==c?void 0:c.baseCaseId)||"").trim(),f=String((null==c?void 0:c.baseEmailDocId)||"").trim(),a?(console.log("[readIntentAny] Intent found:",{itemKey:o,caseId:a,autoFileOnSend:l,hasBase:!(!u||!f)}),[2,{itemKey:o,caseId:a,autoFileOnSend:l,baseCaseId:u||void 0,baseEmailDocId:f||void 0}]):[3,8]):[3,8];case 7:return d=g.sent(),console.warn("[readIntentAny] Failed to read intent for key:",r,d),[3,8];case 8:return t++,[3,1];case 9:return console.warn("[readIntentAny] No intent found for any key"),[2,null]}})})}function X(){return G(this,void 0,void 0,function(){var e,t,n;return J(this,function(o){switch(o.label){case 0:return(e=Office.context.mailbox.item)?(console.log("[getSubjectRuntime] Item type:",e.itemType,"Mode:",e.itemClass),"string"==typeof e.subject?(t=String(e.subject||""),console.log("[getSubjectRuntime] Direct string subject:",t),[2,t]):(null===(n=null==e?void 0:e.subject)||void 0===n?void 0:n.getAsync)?[4,new z(function(t){e.subject.getAsync(function(e){if((null==e?void 0:e.status)===Office.AsyncResultStatus.Succeeded){var n=String(e.value||"");console.log("[getSubjectRuntime] Async subject:",n),t(n)}else console.warn("[getSubjectRuntime] getAsync failed:",null==e?void 0:e.error),t("")})})]:[3,2]):(console.warn("[getSubjectRuntime] No item available"),[2,""]);case 1:return[2,o.sent()||""];case 2:return console.warn("[getSubjectRuntime] No subject API available"),[2,""]}})})}function Z(){return G(this,void 0,void 0,function(){var e,t,n;return J(this,function(o){switch(o.label){case 0:return e=Office.context.mailbox.item,(null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.getAsync)?[4,new z(function(t){e.body.getAsync(Office.CoercionType.Text,function(e){(null==e?void 0:e.status)===Office.AsyncResultStatus.Succeeded?t(String(e.value||"")):t("")})})]:[2,""];case 1:return t=o.sent(),[2,String(t||"")]}})})}function ee(e){return G(this,void 0,void 0,function(){var t,n;return J(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),t=Office.context.mailbox.item,(null===(n=null==t?void 0:t.notificationMessages)||void 0===n?void 0:n.replaceAsync)?[4,new z(function(n){t.notificationMessages.replaceAsync("sc_send",{type:"informationalMessage",message:e,icon:"Icon.16x16",persistent:!1},function(){return n()})})]:[2];case 1:case 2:return o.sent(),[3,3];case 3:return[2]}})})}function te(e){return G(this,void 0,void 0,function(){var t,n,o,r,i,s,c,a,l,u,f,d,h,v,p,y,b,S,w,O,x,_,j,R,A,C,T,E,H,D,U,P,B,G,te,ne,oe,re,ie,se,ce,ae,le,ue,fe,de,me,ge;return J(this,function(J){switch(J.label){case 0:console.log("[onMessageSendHandler] Handler fired"),console.log("[onMessageSendHandler] Platform info",{hasOfficeRuntime:"undefined"!=typeof OfficeRuntime,hasOfficeRuntimeStorage:void 0!==(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage),hasRoamingSettings:!!(null===(B=null===Office||void 0===Office?void 0:Office.context)||void 0===B?void 0:B.roamingSettings),host:null===(ne=null===(te=null===(G=null===Office||void 0===Office?void 0:Office.context)||void 0===G?void 0:G.mailbox)||void 0===te?void 0:te.diagnostics)||void 0===ne?void 0:ne.hostName,hostVersion:null===(ie=null===(re=null===(oe=null===Office||void 0===Office?void 0:Office.context)||void 0===oe?void 0:oe.mailbox)||void 0===re?void 0:re.diagnostics)||void 0===ie?void 0:ie.hostVersion}),t=!1,n=function(n,o){if(!t){t=!0,console.log("[onMessageSendHandler] Finishing",{allowEvent:n,hasErrorMessage:!!o});try{o?e.completed({allowEvent:n,errorMessage:o}):e.completed({allowEvent:n})}catch(e){console.error("[onMessageSendHandler] Error in event.completed:",e)}}},J.label=1;case 1:return J.trys.push([1,42,,47]),console.log("[onMessageSendHandler] Clearing expired auth"),[4,W(g(),700)];case 2:return J.sent(),console.log("[onMessageSendHandler] Getting candidate item keys"),[4,W($(),2e3)];case 3:return o=J.sent(),console.log("[onMessageSendHandler] Item keys:",o),0===o.length?(console.log("[onMessageSendHandler] No item keys found, skipping"),n(!0),[2]):(console.log("[onMessageSendHandler] Reading intent from storage",{storageType:"undefined"!=typeof OfficeRuntime&&(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage)?"OfficeRuntime":"roamingSettings",keysToTry:o}),[4,W(Q(o),1500)]);case 4:if(r=J.sent(),console.log("[onMessageSendHandler] Intent:",r,{found:!!r,foundUnderKey:null==r?void 0:r.itemKey}),!(null==r?void 0:r.autoFileOnSend)||!r.caseId)return console.log("[onMessageSendHandler] No auto-file intent or case ID, skipping"),n(!0),[2];J.label=5;case 5:return J.trys.push([5,14,,15]),("draft:current"===r.itemKey||"last_compose"===r.itemKey)&&(i=o.find(function(e){return!e.startsWith("draft:")&&"last_compose"!==e}))?(console.log("[onMessageSendHandler] Migrating intent from fallback",{from:r.itemKey,to:i}),s=JSON.stringify({caseId:r.caseId,autoFileOnSend:r.autoFileOnSend,baseCaseId:r.baseCaseId||"",baseEmailDocId:r.baseEmailDocId||""}),c="sc_intent:".concat(i),"undefined"!=typeof OfficeRuntime&&(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage)?[4,OfficeRuntime.storage.setItem(c,s)]:[3,7]):[3,13];case 6:return J.sent(),console.log("[onMessageSendHandler] Migrated to OfficeRuntime.storage"),[3,9];case 7:return(null===(se=null===Office||void 0===Office?void 0:Office.context)||void 0===se?void 0:se.roamingSettings)?(Office.context.roamingSettings.set(c,s),[4,new z(function(e){Office.context.roamingSettings.saveAsync(function(){return e()})})]):[3,9];case 8:J.sent(),console.log("[onMessageSendHandler] Migrated to roamingSettings"),J.label=9;case 9:return a="sc_intent:".concat(r.itemKey),"undefined"!=typeof OfficeRuntime&&(null===OfficeRuntime||void 0===OfficeRuntime?void 0:OfficeRuntime.storage)?[4,OfficeRuntime.storage.removeItem(a)]:[3,11];case 10:return J.sent(),console.log("[onMessageSendHandler] Cleared fallback key from OfficeRuntime.storage"),[3,13];case 11:return(null===(ce=null===Office||void 0===Office?void 0:Office.context)||void 0===ce?void 0:ce.roamingSettings)?(Office.context.roamingSettings.remove(a),[4,new z(function(e){Office.context.roamingSettings.saveAsync(function(){return e()})})]):[3,13];case 12:J.sent(),console.log("[onMessageSendHandler] Cleared fallback key from roamingSettings"),J.label=13;case 13:return[3,15];case 14:return l=J.sent(),console.warn("[onMessageSendHandler] Intent migration failed (non-critical):",l),[3,15];case 15:return console.log("[onMessageSendHandler] Getting auth token"),[4,W(m(),900)];case 16:return(u=J.sent().token)?[3,18]:(console.error("[onMessageSendHandler] No auth token available"),[4,ee("SingleCase: chybí přihlášení, nelze zařadit při odeslání.")]);case 17:return J.sent(),n(!0),[2];case 18:return console.log("[onMessageSendHandler] Token retrieved",{tokenPrefix:u.slice(0,10)}),console.log("[onMessageSendHandler] Getting workspace host"),[4,I(k)];case 19:return f=J.sent()||"",d=function(e){var t=(e||"").trim().toLowerCase();return t?t.replace(/^https?:\/\//i,"").split("/")[0]:""}(f),console.log("[onMessageSendHandler] Workspace host",{hostRaw:f,normalized:d}),d?[3,21]:(console.error("[onMessageSendHandler] No workspace host configured"),[4,ee("SingleCase: chybí workspace URL, nelze zařadit při odeslání.")]);case 20:return J.sent(),n(!0),[2];case 21:return console.log("[onMessageSendHandler] Skipping pre-flight check, proceeding to upload"),console.log("[onMessageSendHandler] Reading email metadata"),console.log("[onMessageSendHandler] Current item info:",{itemType:null===(ae=Office.context.mailbox.item)||void 0===ae?void 0:ae.itemType,itemClass:null===(le=Office.context.mailbox.item)||void 0===le?void 0:le.itemClass,hasSubject:!!(null===(ue=Office.context.mailbox.item)||void 0===ue?void 0:ue.subject)}),[4,W(X(),1500)];case 22:return h=J.sent(),[4,W(Z(),2500)];case 23:v=J.sent(),p=null===(fe=Office.context.mailbox.item)||void 0===fe?void 0:fe.from,y=String((null==p?void 0:p.emailAddress)||(null===(de=Office.context.mailbox.userProfile)||void 0===de?void 0:de.emailAddress)||""),b=String((null==p?void 0:p.displayName)||(null===(me=Office.context.mailbox.userProfile)||void 0===me?void 0:me.displayName)||""),S=Y(),console.log("[onMessageSendHandler] Email metadata",{subject:h,fromEmail:y,fromName:b,bodyLength:v.length,hasConversationId:!!S,conversationIdPreview:S?S.substring(0,30)+"...":"(none)"}),w=(h||"email").trim().replace(/[<>:"/\\|?*\x00-\x1F]/g," ").replace(/\s+/g," ").trim().slice(0,80)||"email",O="From: ".concat(b," <").concat(y,">\r\n")+"To: SingleCase <noreply@singlecase>\r\n"+"Subject: ".concat(h,"\r\n")+"Date: ".concat((new Date).toUTCString(),"\r\n")+"Message-ID: <".concat(o[0],"@outlook>\r\n")+"MIME-Version: 1.0\r\nContent-Type: text/plain; charset=UTF-8\r\nContent-Transfer-Encoding: 8bit\r\n\r\n"+"".concat((v||"").trim(),"\r\n"),x=function(e){for(var t=(new TextEncoder).encode(e),n="",o=0;o<t.length;o+=1)n+=String.fromCharCode(t[o]);return btoa(n)}(O),console.log("[onMessageSendHandler] EML built",{length:x.length}),_=null,J.label=24;case 24:return J.trys.push([24,26,,27]),console.log("[onMessageSendHandler] Checking for existing document with same subject"),[4,W(F(r.caseId,h),V)];case 25:return(_=J.sent())?console.log("[onMessageSendHandler] Found existing document",{docId:_.id,docName:_.name,docSubject:_.subject}):console.log("[onMessageSendHandler] No existing document with this subject found"),[3,27];case 26:return j=J.sent(),console.warn("[onMessageSendHandler] Failed to check for existing document:",j),_=null,[3,27];case 27:return R=!!_,console.log("[onMessageSendHandler] Version decision",{caseId:r.caseId,subject:h,existingDocId:null==_?void 0:_.id,existingDocName:null==_?void 0:_.name,shouldUploadVersion:R}),R&&_?(console.log("[onMessageSendHandler] Uploading as version of existing document:",_.id),[4,W(M({documentId:_.id,fileName:"".concat(w,".eml"),mimeType:"message/rfc822",dataBase64:x}),V)]):[3,34];case 28:return J.sent(),console.log("[onMessageSendHandler] Version uploaded successfully"),[4,q(r.caseId,_.id)];case 29:return J.sent(),(A=Y())?[4,K(A,r.caseId,_.id,h)]:[3,31];case 30:return J.sent(),console.log("[onMessageSendHandler] Cached filed email (version)",{conversationId:A.substring(0,20)+"..."}),[3,33];case 31:return[4,L(h,r.caseId,_.id)];case 32:J.sent(),console.log("[onMessageSendHandler] Cached filed email by subject (version)",{subject:h}),J.label=33;case 33:return[3,40];case 34:return console.log("[onMessageSendHandler] Uploading as new document"),[4,W(N({caseId:r.caseId,fileName:"".concat(w,".eml"),mimeType:"message/rfc822",dataBase64:x,metadata:{subject:h,fromEmail:y,fromName:b,conversationId:S||void 0}}),V)];case 35:return C=J.sent(),T=null==C?void 0:C.documents,E=Array.isArray(T)&&(null===(ge=T[0])||void 0===ge?void 0:ge.id)?String(T[0].id):"",console.log("[onMessageSendHandler] Created docId",{createdDocId:E,rawResponse:C}),E?[4,q(r.caseId,E)]:[3,40];case 36:return J.sent(),(H=Y())?[4,K(H,r.caseId,E,h)]:[3,38];case 37:return J.sent(),console.log("[onMessageSendHandler] Cached filed email (new doc)",{conversationId:H.substring(0,20)+"..."}),[3,40];case 38:return[4,L(h,r.caseId,E)];case 39:J.sent(),console.log("[onMessageSendHandler] Cached filed email by subject (new doc)",{subject:h}),J.label=40;case 40:return console.log("[onMessageSendHandler] Upload successful"),[4,ee("SingleCase: email uložen při odeslání.")];case 41:return J.sent(),n(!0),[3,47];case 42:D=J.sent(),console.error("[onMessageSendHandler] Error during filing",D),J.label=43;case 43:return J.trys.push([43,45,,46]),U=D instanceof Error?D.message:String(D),P="",U.includes("timeout")?P=" (timeout)":U.toLowerCase().includes("workspace")?P=" (není nastaven workspace)":U.toLowerCase().includes("token")?P=" (přihlaste se znovu)":U.toLowerCase().includes("network")&&(P=" (problém se sítí)"),[4,ee("SingleCase: nepodařilo se uložit".concat(P))];case 44:case 45:return J.sent(),[3,46];case 46:return n(!0),[3,47];case 47:return[2]}})})}var ne=n(64583).Promise;console.log("[commands.ts] Script loaded");var oe=!1;function re(){var e;if(!oe){oe=!0;try{if(!(null===(e=null===Office||void 0===Office?void 0:Office.actions)||void 0===e?void 0:e.associate))return void console.warn("[commands.ts] Office.actions.associate not available");console.log("[commands.ts] Associating onMessageSendHandler"),Office.actions.associate("onMessageSendHandler",te),console.log("[commands.ts] Handler associated successfully")}catch(e){console.error("[commands.ts] Failed to associate handler:",e)}}}!function(){var e,t,n,o;e=this,t=void 0,o=function(){var e;return function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=c(0),s.throw=c(1),s.return=c(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,4,5,6]),"function"!=typeof(null===Office||void 0===Office?void 0:Office.onReady)?[3,2]:[4,Office.onReady()];case 1:return t.sent(),console.log("[commands.ts] Office.onReady fired"),console.log("[commands.ts] Office.context:",Office.context),[3,3];case 2:console.warn("[commands.ts] Office.onReady not available"),t.label=3;case 3:return[3,6];case 4:return e=t.sent(),console.error("[commands.ts] Office.onReady failed:",e),[3,6];case 5:return re(),[7];case 6:return[2]}})},new((n=void 0)||(n=ne))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}a((o=o.apply(e,t||[])).next())})}();try{"function"==typeof(null===Office||void 0===Office?void 0:Office.onReady)&&Office.onReady(function(){re()})}catch(e){}}()}();
//# sourceMappingURL=commands.js.map